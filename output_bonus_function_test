ERROR:  42702: column reference "checkpoint_id" is ambiguous
DETAIL:  It could refer to either a PL/pgSQL variable or a table column.
QUERY:  WITH overdue_data AS (
    -- Find overdue checkpoints (not already processed)
    SELECT DISTINCT
      c.id as checkpoint_id,
      c.goal_id,
      g.user_id,
      'checkpoint'::TEXT as failure_type,
      -- Determine consequence types based on goal setup
      ARRAY[
        CASE WHEN g.monetary_stake > 0 THEN 'monetary'::consequence_type_enum END,
        CASE WHEN g.minor_kompromat_id IS NOT NULL THEN 'humiliation_email'::consequence_type_enum END
      ]::consequence_type_enum[] as consequence_types,
      g.monetary_stake,
      g.minor_kompromat_id,
      g.major_kompromat_id,
      g.charity_destination
    FROM checkpoints c
    INNER JOIN goals g ON c.goal_id = g.id
    WHERE 
      c.status = 'pending'
      AND c.deadline < NOW()
      AND g.status = 'active'
      -- Ensure we haven't already processed this failure
      AND NOT EXISTS (
        SELECT 1 FROM consequences 
        WHERE checkpoint_id = c.id 
        AND execution_status != 'failed'
      )
    
    UNION ALL
    
    -- Find overdue final deadlines (goals completely failed)
    SELECT DISTINCT
      NULL::UUID as checkpoint_id,
      g.id as goal_id,
      g.user_id,
      'final_deadline'::TEXT as failure_type,
      -- Final deadlines get all available consequence types
      ARRAY[
        CASE WHEN g.monetary_stake > 0 THEN 'monetary'::consequence_type_enum END,
        CASE WHEN g.major_kompromat_id IS NOT NULL THEN 'humiliation_email'::consequence_type_enum END
      ]::consequence_type_enum[] as consequence_types,
      g.monetary_stake,
      g.minor_kompromat_id,
      g.major_kompromat_id,
      g.charity_destination
    FROM goals g
    WHERE 
      g.status = 'active'
      AND g.final_deadline < NOW()
      -- Ensure we haven't already processed this final failure
      AND NOT EXISTS (
        SELECT 1 FROM consequences 
        WHERE goal_id = g.id 
        AND checkpoint_id IS NULL
        AND execution_status != 'failed'
      )
  )
  SELECT 
    od.checkpoint_id,
    od.goal_id,
    od.user_id,
    od.failure_type,
    -- Clean up NULL values from consequence types array
    array_remove(od.consequence_types, NULL) as consequence_types,
    od.monetary_stake,
    od.minor_kompromat_id,
    od.major_kompromat_id,
    od.charity_destination
  FROM overdue_data od
  WHERE array_length(array_remove(od.consequence_types, NULL), 1) > 0
CONTEXT:  PL/pgSQL function check_overdue_checkpoints() line 3 at RETURN QUERY
SQL statement "SELECT COUNT(*)                        FROM check_overdue_checkpoints()"
PL/pgSQL function trigger_consequence_processing() line 10 at SQL statement
SQL statement "SELECT trigger_consequence_processing()"
PL/pgSQL function manual_consequence_trigger() line 5 at PERFORM